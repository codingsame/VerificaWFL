<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wfl-verifica</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="{{url_for('static', filename='html5-qrcode.min.js')}}" type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.7.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>

    <nav class="nav">
        <a class="nav__link nav__link--active" onclick="setActive(this); showHidden()">
            <i class="ri-money-euro-box-line"></i>
            <span class="nav__text">Win For Life Classico</span>
        </a>
        <a class="nav__link nav__link" onclick="setActive(this)">
            <i class="ri-building-4-line"></i>
            <span class="nav__text">Win For Life Grattacieli</span>
        </a>
        <a class="nav__link" onclick="setActive(this)">
            <i class="ri-home-6-line"></i>
            <span class="nav__text">Vinci Casa</span>
        </a>
        <a href="#archive" class="nav__link" onclick="setActive(this)">
            <i class="ri-wallet-3-line"></i>
            <span class="nav__text">Archivio</span>
        </a>

    </nav>
    <div class="centered-text rounded">
        <h1 class="rounded" style="background-color: #007E47; color:white"> Verifica vincite Win For Life </h1>
    </div>

    <div class="flex-container">
        <div id="popup" class="popup">
            <img id="outcome" />
            <h2 id="win-message"></h2>
            <p>Vuoi aggiungere questa schedina al tuo archivio?</p>
            <div class="flex-container-row">
                <button id="addButton" type="button" class="btn btn-outline-success flex-fill"
                    onclick="closePopup(true);">Aggiungi</button>
                <button id="skipButton" type="button" class="btn btn-outline-primary"
                    onclick="closePopup(false);">Prosegui</button>
            </div>
        </div>
        <div class="container">

            <div class="flex-container-row rounded flex-center" style="background-color: white;">

                <input type="radio" class="btn-check rounded" name="gametype" id="classico-check" value='classico'
                    onclick="showHidden();">
                <label class="btn btn-outline-success rounded" for="classico-check">Win For Life
                    Classico</label>

                <input type="radio" class="btn-check" name="gametype" id="grattacieli-check" value="grattacieli"
                    onclick="showHidden();">
                <label class="btn btn-outline-success" for="grattacieli-check">Win For Life Grattacieli</label>

            </div>
            <main class="rounded readerSize" id="qrReader" hidden>
                <div id="reader" class="rounded"></div>
                <div id="result"></div>
            </main>
        </div>
    </div>
    <div class="flex-container flex-center">
        <a id="archiveToggle" class="btn btn-primary" data-bs-toggle="collapse" href="#archive" role="button"
            aria-expanded="false" aria-controls="archive">
            Archivio vincite
        </a>
    </div>
    <div class="collapse" id="archive">
        <div class="card card-body">
            <table id="winArchive" class="table">
                <thead>
                    <tr>
                        <th>Tipologia Gioco</th>
                        <th>Concorso</th>
                        <th>Codice Schedina</th>
                        <th>Vincita</th>
                    </tr>
                </thead>
            </table>
            <h1 id="winTotal" hidden>Vincita totale: </h1>
            <div class="btn btn-danger" id="clearWinArchive" onclick="clearArchive();">Svuota archivio</div>
        </div>
    </div>
    </div>

</body>

<script>

    if (localStorage.getItem("savedGames") === null)
        document.getElementById('clearWinArchive').hidden = true;

    function clearArchive() {
        let res = confirm("Sei sicuro di voler svuotare l'archivio?");
        if (res) {
            localStorage.setItem("savedGames", "[]");
            location.reload();
        }
    }

    if (!(localStorage.getItem("savedGames") === null)) {
        let total = 0;
        const data = JSON.parse(localStorage.getItem("savedGames"));
        let outcomeList = document.getElementById('winArchive');

        for (let game of data) {
            let truegame = JSON.parse(game);

            let gioco = truegame['gioco'];
            let contest = truegame['contest'];
            let id = truegame['idschedina'];
            let amount = truegame['amount'];

            let newOutcome = document.createElement('tr');
            let gametd = document.createElement('td');
            let contesttd = document.createElement('td');
            let idtd = document.createElement('td');
            let amounttd = document.createElement('td');

            gametd.innerText = gioco;
            contesttd.innerText = contest;
            idtd.innerText = id;
            amounttd.innerText = amount;

            newOutcome.appendChild(gametd);
            newOutcome.appendChild(contesttd);
            newOutcome.appendChild(idtd);
            newOutcome.appendChild(amounttd);

            outcomeList.appendChild(newOutcome);

            total += amount;
        }
        let winTotal = document.getElementById('winTotal')
        winTotal.innerText = `Vincita totale: ${total}`;
        winTotal.hidden = false;
    }
    const scanner = new Html5QrcodeScanner('reader', {
        qrbox: {
            height: 250,
            width: 250
        },
        fps: 20,
        aspectRatio: 1
    });
    let currentGame;

    function closePopup(acceptSaveOutcome) {
        document.getElementById("addButton").hidden = false;
        document.getElementById("skipButton").classList.remove("flex-fill");
        if (acceptSaveOutcome) {
            if (localStorage.getItem("savedGames") === null) {
                localStorage.setItem("savedGames", "[]");
            }

            let currentSavedGames = JSON.parse(localStorage.getItem("savedGames"));
            let gameAlreadyScanned = false;
            for (let game of currentSavedGames) {
                let truegame = JSON.parse(game);
                if (truegame["idschedina"] == JSON.parse(currentGame)["idschedina"])
                    gameAlreadyScanned = true;
            }

            if (!gameAlreadyScanned) {
                currentSavedGames.push(currentGame);

                localStorage.setItem("savedGames", JSON.stringify(currentSavedGames));
                let outcomeList = document.getElementById('winArchive');

                let cg = JSON.parse(currentGame);

                let game = cg['gioco'];
                let contest = cg['contest'];
                let id = cg['idschedina'];
                let amount = cg['amount'];

                let newOutcome = document.createElement('tr');
                let gametd = document.createElement('td');
                let contesttd = document.createElement('td');
                let idtd = document.createElement('td');
                let amounttd = document.createElement('td');

                gametd.innerText = game;
                contesttd.innerText = contest;
                idtd.innerText = id;
                amounttd.innerText = amount;

                newOutcome.appendChild(gametd);
                newOutcome.appendChild(contesttd);
                newOutcome.appendChild(idtd);
                newOutcome.appendChild(amounttd);

                outcomeList.appendChild(newOutcome);
            }
            let clearButton = document.getElementById('clearWinArchive')
            if (clearButton.hidden == true)
                clearButton.hidden = false;
        }
        let popup = document.getElementById('popup');
        popup.classList.remove('open-popup');
        scanner.render(success, error);
    }

    function showHidden() {
        document.getElementById('qrReader').hidden = false;
    }


    scanner.render(success, error);

    function success(res) {
        scanner.clear();
        let path = '/checkwin'
        const url = new URL(res);

        const y = url.searchParams.get('Y');
        const c = url.searchParams.get('C');
        const prsn = url.searchParams.get('PrSN');
        const gt = $("input[name='gametype']:checked").val();

        $.ajax({
            type: 'POST',
            url: "/checkwin",
            data: {
                'Y': y,
                'C': c,
                'PrSN': prsn,
                'game_type': gt
            },
            success: function (text) {
                let winmsg;
                let msg_element = document.getElementById('win-message');
                let popup = document.getElementById('popup');
                let image = document.getElementById('outcome');
                if (text['amount'] == -1) {
                    winmsg = "Estrazione non ancora svolta.";
                    image.src = "{{url_for('static', filename='question.png')}}"
                    document.getElementById("addButton").hidden = true;
                    document.getElementById("skipButton").classList.add("flex-fill")
                }
                else if (text['amount'] == 0) {
                    winmsg = "Schedina non vincente";
                    image.src = "{{url_for('static', filename='fail.png')}}"
                }
                else {
                    winmsg = "Hai vinto " + text['amount'] + "€.";
                    image.src = "{{url_for('static', filename='tick.png')}}"
                }
                msg_element.innerText = winmsg;
                popup.classList.add('open-popup');
                currentGame = JSON.stringify(text);
            }
        }
        )
    }

    function error(res) {
    }

    function setActive(tab) {
        let currentlyActive = document.getElementsByClassName("nav__link--active");
        currentlyActive[0].classList.remove("nav__link--active");
        tab.classList.add("nav__link--active");
    }
</script>

</html>